<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>克里金等值面展示示例</title>
    <!-- <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css" /> -->
    <!-- <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script> -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=1d3c872bd5052045938f40ee5c444982"></script>
    <script src="./kriging_contour.js"></script>
    <style>
      #map {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <button onclick="showKrigingVector()">克里金矢量(Vector)</button>
    <button onclick="showKrigingImage()">克里金图像(Image)</button>
    <div id="map"></div>
    <script>
      var boundaryCoordinates = [
        [
          [121.632636, 30.072124],
          [121.623825, 30.067462],
          [121.620069, 30.063027],
          [121.61332, 30.05274],
          [121.612134, 30.049072],
          [121.609832, 30.045843],
          [121.603026, 30.040789],
          [121.600089, 30.040088],
          [121.594865, 30.040446],
          [121.581268, 30.038457],
          [121.577286, 30.038653],
          [121.57233, 30.040919],
          [121.563236, 30.044115],
          [121.558873, 30.050132],
          [121.55653, 30.051876],
          [121.548552, 30.054045],
          [121.547747, 30.056376],
          [121.542749, 30.055267],
          [121.539106, 30.055137],
          [121.535053, 30.053898],
          [121.531311, 30.054534],
          [121.529589, 30.056425],
          [121.52685, 30.055039],
          [121.525452, 30.055838],
          [121.524901, 30.058968],
          [121.522486, 30.060403],
          [121.516542, 30.058903],
          [121.510357, 30.058479],
          [121.505133, 30.054436],
          [121.497438, 30.052675],
          [121.493625, 30.052805],
          [121.492143, 30.048827],
          [121.493244, 30.045305],
          [121.487427, 30.042648],
          [121.480805, 30.043952],
          [121.478602, 30.043186],
          [121.477995, 30.041278],
          [121.47928, 30.038848],
          [121.477148, 30.035832],
          [121.473745, 30.035],
          [121.466431, 30.035065],
          [121.466459, 30.033027],
          [121.469636, 30.028705],
          [121.474211, 30.024547],
          [121.47582, 30.020894],
          [121.478842, 30.017257],
          [121.481228, 30.013196],
          [121.485323, 30.009836],
          [121.48857, 29.999951],
          [121.488218, 29.997667],
          [121.484928, 29.995171],
          [121.484546, 29.992593],
          [121.488302, 29.989216],
          [121.494473, 29.989983],
          [121.501067, 29.989983],
          [121.503072, 29.989233],
          [121.506206, 29.986166],
          [121.511572, 29.98566],
          [121.513534, 29.982984],
          [121.52099, 29.984616],
          [121.522599, 29.986916],
          [121.527796, 29.988303],
          [121.532201, 29.985692],
          [121.533909, 29.983898],
          [121.536959, 29.983229],
          [121.548566, 29.973227],
          [121.552872, 29.96887],
          [121.55396, 29.965101],
          [121.55749, 29.966488],
          [121.562658, 29.961233],
          [121.562079, 29.958802],
          [121.567232, 29.95983],
          [121.569718, 29.959455],
          [121.570282, 29.957725],
          [121.573685, 29.956893],
          [121.575408, 29.95229],
          [121.578585, 29.952127],
          [121.579079, 29.946823],
          [121.587452, 29.939396],
          [121.587904, 29.940425],
          [121.595373, 29.936638],
          [121.595529, 29.939788],
          [121.600315, 29.93858],
          [121.601586, 29.93605],
          [121.600457, 29.932704],
          [121.603874, 29.929537],
          [121.602151, 29.926648],
          [121.60297, 29.915579],
          [121.607841, 29.913359],
          [121.60962, 29.915481],
          [121.612374, 29.913783],
          [121.617768, 29.918126],
          [121.620775, 29.916004],
          [121.621481, 29.913914],
          [121.631068, 29.914991],
          [121.633723, 29.913587],
          [121.633667, 29.91153],
          [121.640091, 29.911938],
          [121.643183, 29.912738],
          [121.645923, 29.908477],
          [121.640811, 29.901488],
          [121.639795, 29.902158],
          [121.63618, 29.898941],
          [121.639484, 29.894859],
          [121.641221, 29.894499],
          [121.64533, 29.89592],
          [121.646869, 29.897553],
          [121.6527, 29.90753],
          [121.656329, 29.912395],
          [121.659887, 29.915138],
          [121.663572, 29.916069],
          [121.671917, 29.917212],
          [121.676478, 29.918403],
          [121.682973, 29.92095],
          [121.685727, 29.92304],
          [121.68968, 29.927513],
          [121.694128, 29.937748],
          [121.697926, 29.943559],
          [121.699733, 29.944783],
          [121.704986, 29.946007],
          [121.715618, 29.944766],
          [121.721831, 29.946284],
          [121.72498, 29.948961],
          [121.726957, 29.951686],
          [121.730416, 29.959389],
          [121.732492, 29.962686],
          [121.737674, 29.966994],
          [121.74479, 29.970094],
          [121.756298, 29.972672],
          [121.766436, 29.976572],
          [121.788392, 29.990799],
          [121.784029, 29.993507],
          [121.771434, 29.994959],
          [121.761706, 29.994649],
          [121.725008, 29.992218],
          [121.721083, 29.992969],
          [121.699776, 30.008041],
          [121.672666, 30.043724],
          [121.667484, 30.048876],
          [121.657769, 30.067445],
          [121.653095, 30.071129],
          [121.644567, 30.070966],
          [121.635347, 30.069825],
          [121.632636, 30.072124],
        ],
      ];

      

      // PM10数据，示例
      var pm10Data = [
        { lon: 121.466429, lat: 29.8945, value: 1 },
        { lon: 121.788396, lat: 30.072124, value: 1 },
        { lon: 121.584722, lat: 29.959444, value: 80 },
        { lon: 121.5994786, lat: 30.03384923, value: 160 },
        { lon: 121.7160915, lat: 29.95766428, value: 260 },
        { lon: 121.6933333, lat: 29.96055556, value: 45 },
        { lon: 121.712723, lat: 29.955827, value: 110 },
        { lon: 121.6646265, lat: 29.94811803, value: 21 },
        { lon: 121.5054021, lat: 30.03474959, value: 160 },
        { lon: 121.633, lat: 30.0262, value: 140 },
      ];

      function interpolateColor(color1, color2, factor) {
          if (arguments.length < 3) {
              factor = 0.5;
          }
          const result = color1.slice();
          for (let i = 0; i < 3; i++) {
              result[i] = Math.round(result[i] + factor * (color2[i] - result[i]));
          }
          return result;
      }

      function rgbToHex(r, g, b) {
          const toHex = (c) => {
              const hex = c.toString(16);
              return hex.length === 1 ? '0' + hex : hex;
          };
          return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }

      function generateGradientColors(startColor, endColor, steps) {
          const colors = [];
          for (let i = 0; i <= steps; i++) {
              const factor = i / steps;
              const interpolatedColor = interpolateColor(startColor, endColor, factor);
              colors.push(rgbToHex(interpolatedColor[0], interpolatedColor[1], interpolatedColor[2]));
          }
          return colors;
      }

      const green = [0, 228, 0];
      const yellow = [225, 225, 0];
      const orange = [225, 126, 0];
      const red = [225, 0, 0];
      const purple = [153, 0, 76];
      const shen  = [100, 0, 35];

      const greenToYellow = generateGradientColors(green, yellow, 10);
      const yellowToOrange = generateGradientColors(yellow, orange, 10);
      const orangeToRed = generateGradientColors(orange, red, 10);
      const redToPurple = generateGradientColors(red, purple, 10);
      const purpleToShen = generateGradientColors(purple, shen, 10);

      const colors = [
          ...greenToYellow,
          ...yellowToOrange,
          ...orangeToRed,
          ...redToPurple,
          ...purpleToShen
      ];

      let params = {
        mapCenter: [121.596686, 29.965212],
        maxValue: 10000,
        krigingModel: "exponential", //'exponential','gaussian','spherical'
        krigingSigma2: 0,
        krigingAlpha: 100,
        canvasAlpha: 0.7,
        colors: colors,
        // colors: [
        //   "#006837",
        //   "#1a9850",
        //   "#66bd63",
        //   "#a6d96a",
        //   "#d9ef8b",
        //   "#ffffbf",
        //   "#fee08b",
        //   "#fdae61",
        //   "#f46d43",
        //   "#d73027",
        //   "#a50026",
        // ],
      };

      //生成测试数据
      let dataset = {
        type: "FeatureCollection",
        features: [],
      };
      pm10Data.forEach((element) => {
        let feature = {
          type: "Feature",
          properties: {
            level: element.value,
          },
          geometry: {
            type: "Point",
            coordinates: [element.lon, element.lat],
          },
        };
        dataset.features.push(feature);
      });


      const breaks = [];
      for (let index = 1; index < 500; index++) {
        breaks.push(index);
      }


      //生成矢量等值面并渲染
      function showKrigingVector() {
        //生成克里金矢量等值面
        let kriging_contours = kriging_contour.getVectorContourWithClip(
          dataset,
          "level",
          {
            model: "exponential",
            sigma2: 0,
            alpha: 100,
          },
          breaks,
          // [0,  50, 100, 150, 200, 300, 400],
          boundaryCoordinates
        );
        console.log("kriging_contours");
        console.log(kriging_contours);

        // 绘制
        map.clearMap();
        var overlayGroup = [];
        kriging_contours.forEach((feature) => {
          feature.geometry.coordinates.forEach((coordinate) => {
            // coordinates
            let value = feature.properties.value;
            let level = parseInt(value) / 10;
            let color = params.colors[level];
            var polygon = new AMap.Polygon({
              path: coordinate, //设置多边形边界路径
              strokeColor: color, //线颜色
              strokeOpacity: 0.2, //线透明度
              strokeWeight: 3, //线宽
              fillColor: color, //填充色
              fillOpacity: 1, //填充透明度
            });
            overlayGroup.push(polygon);
          });
        });
        map.add(new AMap.OverlayGroup(overlayGroup));
      }

      // 创建高德地图
      var map = new AMap.Map("map", {
        zoom: 12,
        center: [121.596686, 29.965212],
      });
    </script>
  </body>
</html>
